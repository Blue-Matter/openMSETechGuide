```{r}
#| eval: true
#| include: false
#| message: false
#| warning: false
#| cache: false
library(MSEtool)
source('../MSEtool/CaseStudies/SimpleOM/SimpleOM.R')
knitr::read_chunk('../MSEtool/CaseStudies/SimpleOM/SimpleOM.R')
```

# Build a `Stock` Object {#sec-stock_build}

A `Stock` object contains the information related the biological characteristics of a stock, including growth and maturity schedules, natural mortality rates, stock-recruitment relationship, and other information relating to spatial distribution and movement patterns (see `?Stock` for more details).

Here an example `Stock` object is created using an expert judgment approach, where most parameters are stochastic.

The stock is loosely based on albacore *Thunnus alalunga* and should only be considered an example for demonstration purposes.

Later, this `Stock` object will be added to the `OM` object created in the previous chapter.

## Create a New `Stock` Object

The `Stock()` function is used to create new `Stock` objects:

```{r initialize-stock}
```

In addition to `Name`, `CommonName`, and `Species` that were specified in the call to the `Stock()` function, `Stock` objects contain several other sub-objects that need to be populated:

1.  `Ages`
2.  `Length`
3.  `Weight`
4.  `NaturalMortality`
5.  `Maturity`
6.  *`Fecundity`*
7.  `SRR`
8.  *`Spatial`*
9.  *`Depletion`*

The sub-objects in italics are optional, see the sections below for details. The other sub-objects must be populated to complete the `Stock` object.

::: callout-tip
## Help Documentation

Help documentation can be accessed for all `openMSE` objects and functions, e.g.,

```{r}
#| eval: false
?OM
?Stock
?Ages
?Length
# etc
```
:::

## Ages

An `Ages` object contains information relating to the age structure of the stock.

```{r create-ages_1}
```

Note that `MaxAge` is set in time units of `quarter`. It is important that the time units in the `Ages` object matches the number of seasons in the `OM`.

Also note that, following the convention in `Years(OM)` the age classes are *always* in units of year:

```{r classes-ages}
```

To keep things simple, we'll change our `OM` back to annual time-steps and re-recreate the `Ages` object accordingly:

```{r create-ages_2}
```

## Length

::: callout-important
Many sub-objects in the `Stock` object are structured and populated in a similar manner to `Length` objects.

This section describes populating `Length` objects in detail. The other sub-objects with a similar structure are described in less detail.

Readers should refer back to this section for the specific details for the different ways to populate those objects.
:::

The `Length` object describes the mean length-at-age schedule and how length-at-age is distributed around the mean. This information is primarily used for two purposes:

1.  Calculating mean weight-at-age from a length-weight relationship a the mean length-at-age
2.  Calculating the age-length key for converting at-age values (such as maturity-at-age) to at-length (i.e., maturity-at-length) and vice versa, and for generating catch-at-length data.

::: callout-note
The `Length` object is optional if no other objects are a function of length (e.g., `Weight`, `Maturity`, `Fecundity` and `Selectivity` etc in the `Fleet` object, and there is no requirement to generate catch-at-length data.
:::

The `Length()` function is used to create `Length` objects.

The help documentation for this function (`?Length`) provides details on the contents of the `Length` object and a description of the arguments for the `Length()` function (@fig-length_help).

Users must provide information to populate `MeanAtAge` and `CVatAge` in a `Length` object.

`MeanAtAge` is common to all objects that contain at-age information, and, as the name suggests, contains information describing the mean at-age schedule (in this case the mean length-at-age).

`CVatAge` contains the coefficient of variability for the distribution of length-at-age, which can be either normally (`Dist='normal'`) or log-normally (`Dist='lognormal'`) distributed around `MeanAtAge`.

Ultimately both `MeanAtAge` and `CVatAge` will be internally 3-dimensional arrays with dimensions containing values for each simulation, age-class, and historical and projection time step (typically years but as noted above, for seasonal models the time steps will actually be decimal years). However, the `openMSE` objects have been designed such that users only need to enter the minimal information to populate the model.

The methodology to populate age- and time-dynamic values is similar for all objects that contain `MeanAtAge` (and `CVatAge` where applicable). The next section describes this process in detail for `Length` objects.

![Screenshot of the help documentation for the `Length` function](images/Length_help.png){#fig-length_help width="60%"}

```{r}

```

## Methods for Populating Age- and Time-Dynamic Values

### Populating `CVatAge`

@fig-length_help shows the that default value for `CVatAge` is a single numeric value `0.1`. This value will be converted internally to an array with the correct dimensions, with a CV of `0.1` for all simulations, ages, and time steps.

There are several ways to include uncertainty in the values for `CVatAge` , and have it vary by simulation, age, and/or time step. These approaches are described in the sub-sections below. In general, all age- and time-dynamic values can be populated in the same manner.

#### Stochastic Samples from Distributions

The easiest way to include uncertainty is to sample from a uniform distribution. To do this, enter to numeric values representing the lower and upper bounds of a uniform distribution:

```{r CV-length-uniform}
```

The above code creates a new `Length` class object with only the `CVatAge` slot populated.

This object is processed internally to sample from a uniform distribution with these bounds and produce an array with the correct dimensions.

This is done internally by the `Populate` function, which is run here on the `Length_CV_uniform` object to demonstrate:

```{r CV-length-uniform-populate}
```

In practice, users will rarely need to call the `Populate` function as this processing is done internally in the `Simulate` function.

`CVatAge` in `Length_CV_uniform` is now a 3-dimensional array:

```{r CV-length-uniform-dim}

```

with the value for each simulation drawn from a uniform distribution with the specified bounds:

```{r CV-length-uniform-head}
```

Once an object has been populated by `Populate` , all dimensions will be named:

```{r CV-length-uniform-dimnames}

```

Notice that while `CVatAge` is a 3-dimensional array, the dimensions `Age` and `Year` are only length 1 and named as the first age-class and year respectively. This is because `CVatAge` in this example only varies by simulation and is constant for all ages-classes and years. Internally, the array will be expanded out for all age-classes and years.

The values for `CVatAge` can also be entered as a vector of length `nSim` (provided `nSim > 2` ). The following are will result in the same output as the code above:

```{r CV-length-other}
#| eval: false
```

This approach can be also used to sample values from different distributions, for example:

```{r CV-length-other-dist}
#| eval: false
```

#### Age-Specific Values

Age-specific values can be generated by specifying `CVatAge` as an array with dimensions `nSim` and `nAge` :

```{r CV-length-age-specific}

```

#### Time- and Age-Specific Values

The same approach can be used to generate values that vary of both age and time:

```{r CV-length-age-time}

```

### Populating `MeanAtAge`

The previous section described the different methods to populate `CVatAge`. Additional methods are used to populate `MeanAtAge`.

The methods described in this section are used to populate `MeanAtAge` for the `Length` object. The same process is used for all objects that contain `MeanAtAge` information (e.g., `?Weight`, `?Maturity`, `?Selectivitity`, etc).

#### Using `Pars` and `Model`

The first two arguments to the `Length()` function are `Pars` and `Model` (@fig-length_help).

These values are used to generate the `MeanAtAge` schedule from a growth model and corresponding parameter values.

Alternatively, as described in the next section, `MeanAtAge` can be populated directly in a similar manner as described above for `CVatAge`.

`Pars` is a named list, with the names of the parameters for (in this case) the growth model specified in `Model`.

`openMSE` includes built-in models for all objects that contain `MeanAtAge` information. Currently there is one built-in length-at-age model, the von Bertalanffy growth function (see also `?vonBert`:

$$
L_a = L_\infty(1-\exp(-K(a-t_0))
$$ {#eq-vonB}

In general, a list of built-in models for a specific object class can be printed to the console with `[CLASS]Models()`. For example `LengthModels()` prints the built-in models corresponding to `Length` objects (@fig-length_models).

![Output printed in the console by `LengthModels()`](images/Length_models.png){#fig-length_models width="60%"}

If the names in `Pars` corresponds with a built-in model, `Model` will be set automatically and does not need to be defined.

Alternatively, `Model` can be a R function that takes an `Ages` object as the first argument followed by the additional parameters that describe the mean length-at-age relationship.

The output from `LengthModels()` shows that the `vonBert` function has three parameters: `Linf`, `K`, `t0` (@fig-length_models). Values for these parameters must be entered in `Pars` in order to use this growth function.

The structure for the values contained in `Pars` is similar to that described for `CVatLength` above, where the values can be constant over all simulations and years, or vary by simulation and/or year.

##### Constant Values over Simulations and Years

```{r length-vonBert_1}
#| eval: false

```

##### `Linf` varies over Simulations, all `Pars` Constant over Years

```{r length-vonBert_2}
#| eval: false
```

##### Time-Varying Parameters

Specifying time-varying parameters is a little more involved.

UPTO HERE - break the code out into sections

```{r length-vonBert_3}

```

#### Populating `MeanAtAge` Directly

```{r create-new-length}
```

Here the process to create and populate a `Length` object is broken into several steps. In practice this can be done in one or two lines of code.

Create a new `Length` object:

```{r create-new-length}

```

The mean length-at-age schedule is stored in a slot named `MeanAtAge`, which can be specified in two ways:

1.  A growth model and a list of the respective parameter values
2.  Directly as an array specifying the mean length-at-age for each simulation and year.

#### Model and Parameters

The `Model` and `Pars` slots are used to generate the mean length-at-age.

`Model` specifies the growth function, and `Pars` is a named list with the parameter values.

```{r create-length}

```

`Model` can either be a character string specifying the name of the growth model corresponding with the named parameters in `Pars`, or

## Create `Length` Object to `SimpleStock`

The above sections described various ways to populate a `Length` object.

Here a `Length` object is created with stochastic values for the growth parameters (`Pars`) and `CVatLength` that vary over simulations, and the object is added to the `SimpleStock` object:

```{r length-stock}

```

## Weight

## NaturalMortality

## Maturity

## Fecundity

## SRR

## Spatial

## Depletion
